{% extends "base.html" %}

{% block title %}Ï¢ÖÎ™© Ï∂îÍ∞Ä - Ï£ºÏãù ÏïåÎ¶º{% endblock %}

{% block content %}
<div class="max-w-md mx-auto" x-data="stockSearch()">
    <h1 class="text-2xl font-bold mb-6">‚ûï Ï¢ÖÎ™© Ï∂îÍ∞Ä</h1>
    
    <div class="bg-slate-800 rounded-2xl p-6 border border-slate-700">
        <form method="POST" class="space-y-4" @submit="submitForm">
            <!-- Íµ≠Í∞Ä ÏÑ†ÌÉù -->
            <div>
                <label class="block text-sm font-medium text-slate-300 mb-2">Íµ≠Í∞Ä</label>
                <div class="grid grid-cols-2 gap-3">
                    <label @click="country = 'US'; search()"
                           class="flex items-center justify-center gap-2 p-4 bg-slate-700 rounded-xl cursor-pointer
                                  border-2 transition-colors"
                           :class="country === 'US' ? 'border-blue-500' : 'border-transparent'">
                        <span class="text-2xl">üá∫üá∏</span>
                        <span>ÎØ∏Íµ≠</span>
                    </label>
                    <label @click="country = 'KR'; search()"
                           class="flex items-center justify-center gap-2 p-4 bg-slate-700 rounded-xl cursor-pointer
                                  border-2 transition-colors"
                           :class="country === 'KR' ? 'border-blue-500' : 'border-transparent'">
                        <span class="text-2xl">üá∞üá∑</span>
                        <span>ÌïúÍµ≠</span>
                    </label>
                </div>
                <input type="hidden" name="country" :value="country">
            </div>
            
            <!-- Ï¢ÖÎ™© Í≤ÄÏÉâ -->
            <div class="relative">
                <label class="block text-sm font-medium text-slate-300 mb-2">Ï¢ÖÎ™© Í≤ÄÏÉâ</label>
                <input type="text"
                       x-model="query"
                       @input.debounce.300ms="search()"
                       @focus="showDropdown = true"
                       @keydown.escape="showDropdown = false"
                       class="w-full px-4 py-3 bg-slate-700 border border-slate-600 rounded-xl
                              text-white placeholder-slate-400
                              focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                       :placeholder="country === 'KR' ? 'Ï¢ÖÎ™©Î™Ö ÎòêÎäî ÏΩîÎìú (Ïòà: ÏÇºÏÑ±Ï†ÑÏûê, KODEX)' : 'Ï¢ÖÎ™©Î™Ö ÎòêÎäî Ìã∞Ïª§ (Ïòà: Apple, TQQQ)'">
                
                <!-- Î°úÎî© ÌëúÏãú -->
                <div x-show="loading" class="absolute right-4 top-10">
                    <svg class="animate-spin h-5 w-5 text-blue-400" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                </div>
                
                <!-- Í≤ÄÏÉâ Í≤∞Í≥º ÎìúÎ°≠Îã§Ïö¥ -->
                <div x-show="showDropdown && results.length > 0"
                     x-transition
                     @click.outside="showDropdown = false"
                     class="absolute z-10 mt-2 w-full bg-slate-700 rounded-xl border border-slate-600 shadow-lg max-h-60 overflow-y-auto">
                    <template x-for="stock in results" :key="stock.ticker">
                        <button type="button"
                                @click="selectStock(stock)"
                                class="w-full px-4 py-3 text-left hover:bg-slate-600 first:rounded-t-xl last:rounded-b-xl
                                       flex items-center justify-between transition-colors">
                            <div>
                                <div class="font-medium" x-text="stock.name"></div>
                                <div class="text-sm text-slate-400">
                                    <span x-text="stock.ticker"></span>
                                    <span class="mx-1">¬∑</span>
                                    <span x-text="stock.market"></span>
                                </div>
                            </div>
                            <span class="text-slate-400">‚Üí</span>
                        </button>
                    </template>
                </div>
                
                <!-- Í≤ÄÏÉâ Í≤∞Í≥º ÏóÜÏùå -->
                <div x-show="showDropdown && query.length >= 2 && results.length === 0 && !loading"
                     class="absolute z-10 mt-2 w-full bg-slate-700 rounded-xl border border-slate-600 p-4 text-center text-slate-400">
                    Í≤ÄÏÉâ Í≤∞Í≥ºÍ∞Ä ÏóÜÏäµÎãàÎã§
                </div>
            </div>
            
            <!-- ÏÑ†ÌÉùÎêú Ï¢ÖÎ™© ÌëúÏãú -->
            <div x-show="selectedStock" class="bg-slate-700/50 rounded-xl p-4 border border-slate-600">
                <div class="flex items-center justify-between">
                    <div>
                        <div class="font-medium text-lg" x-text="selectedStock?.name"></div>
                        <div class="text-sm text-slate-400">
                            <span x-text="selectedStock?.ticker"></span>
                            <span class="mx-1">¬∑</span>
                            <span x-text="selectedStock?.market"></span>
                        </div>
                    </div>
                    <button type="button" @click="clearSelection()" class="text-slate-400 hover:text-red-400 p-2">
                        ‚úï
                    </button>
                </div>
            </div>
            
            <!-- Ïà®Í≤®ÏßÑ Ìã∞Ïª§/Ïù¥Î¶Ñ ÏûÖÎ†• (Í≤ÄÏÉâ + ÏßÅÏ†ëÏûÖÎ†• Î™®Îìú ÌÜµÌï©) -->
            <input type="hidden" name="ticker" :value="manualMode ? (verifiedStock?.ticker || manualTicker.toUpperCase()) : (selectedStock?.ticker || '')">
            <input type="hidden" name="name" :value="manualMode ? (verifiedStock?.name || '') : (selectedStock?.name || '')">
            
            <!-- ÏßÅÏ†ë ÏûÖÎ†• ÌÜ†Í∏Ä -->
            <div class="text-center pt-2">
                <button type="button" @click="manualMode = !manualMode" 
                        class="text-sm text-slate-400 hover:text-blue-400 transition-colors">
                    <span x-text="manualMode ? 'üîç Í≤ÄÏÉâÏúºÎ°ú ÎèåÏïÑÍ∞ÄÍ∏∞' : '‚å®Ô∏è Ìã∞Ïª§ ÏßÅÏ†ë ÏûÖÎ†•'"></span>
                </button>
            </div>
            
            <!-- ÏßÅÏ†ë ÏûÖÎ†• Î™®Îìú -->
            <div x-show="manualMode" x-transition class="space-y-3">
                <div class="relative">
                    <input type="text"
                           x-model="manualTicker"
                           @input="verifiedStock = null; verifyError = ''"
                           @input.debounce.500ms="verifyTicker()"
                           class="w-full px-4 py-3 bg-slate-700 border rounded-xl
                                  text-white placeholder-slate-400 uppercase
                                  focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                           :class="verifyError ? 'border-red-500' : verifiedStock ? 'border-green-500' : 'border-slate-600'"
                           placeholder="Ìã∞Ïª§ ÏßÅÏ†ë ÏûÖÎ†• (Ïòà: TQQQ, 005930)">
                    
                    <!-- Í≤ÄÏ¶ù Ï§ë Î°úÎî© -->
                    <div x-show="verifying" class="absolute right-4 top-3">
                        <svg class="animate-spin h-5 w-5 text-blue-400" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                        </svg>
                    </div>
                    
                    <!-- Í≤ÄÏ¶ù ÏÑ±Í≥µ -->
                    <div x-show="verifiedStock && !verifying" class="absolute right-4 top-3 text-green-400">
                        ‚úì
                    </div>
                </div>
                
                <!-- Í≤ÄÏ¶ùÎêú Ï¢ÖÎ™© Ï†ïÎ≥¥ -->
                <div x-show="verifiedStock" x-transition 
                     class="bg-green-900/30 rounded-xl p-4 border border-green-500/50">
                    <div class="flex items-center justify-between">
                        <div>
                            <div class="text-green-400 text-sm mb-1">‚úì Ï¢ÖÎ™© ÌôïÏù∏Îê®</div>
                            <div class="font-medium text-lg" x-text="verifiedStock?.name"></div>
                            <div class="text-sm text-slate-400">
                                <span x-text="verifiedStock?.ticker"></span>
                                <span class="mx-1">¬∑</span>
                                <span x-text="verifiedStock?.current_price?.toLocaleString()"></span>
                                <span x-text="country === 'KR' ? 'Ïõê' : 'Îã¨Îü¨'"></span>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Í≤ÄÏ¶ù Ïã§Ìå® -->
                <div x-show="verifyError" x-transition
                     class="bg-red-900/30 rounded-xl p-4 border border-red-500/50">
                    <div class="text-red-400">
                        <span class="font-medium">‚úï </span>
                        <span x-text="verifyError"></span>
                    </div>
                </div>
            </div>
            
            <!-- Ìà¨ÏûêÍ∏àÏï° ÏûÖÎ†• (Ï¢ÖÎ™© ÏÑ†ÌÉù ÌõÑ ÌëúÏãú) -->
            <div x-show="selectedStock || verifiedStock" x-transition class="space-y-2">
                <label class="block text-sm font-medium text-slate-300">
                    üí∞ Ìà¨ÏûêÍ∏àÏï° 
                    <span class="text-slate-400" x-text="country === 'KR' ? '(Ïõê)' : '(Îã¨Îü¨)'"></span>
                </label>
                <div class="relative">
                    <input type="number"
                           name="investment_amount"
                           x-model="investmentAmount"
                           step="any"
                           min="0"
                           class="w-full px-4 py-3 bg-slate-700 border border-slate-600 rounded-xl
                                  text-white placeholder-slate-400
                                  focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                           :placeholder="country === 'KR' ? 'Ïòà: 1000000' : 'Ïòà: 1000'">
                    <div class="absolute right-4 top-3 text-slate-400" x-text="country === 'KR' ? '‚Ç©' : '$'"></div>
                </div>
                <p class="text-xs text-slate-500">
                    <span x-show="country === 'KR'">Î™©ÌëúÍ∞Ä ÎèÑÎã¨ Ïãú Î™á Ï£º Îß§ÏàòÌï†ÏßÄ Í≥ÑÏÇ∞Ïóê ÏÇ¨Ïö©Îê©ÎãàÎã§.</span>
                    <span x-show="country === 'US'">Î™©ÌëúÍ∞Ä ÎèÑÎã¨ Ïãú Î™á Ï£º Îß§ÏàòÌï†ÏßÄ Í≥ÑÏÇ∞Ïóê ÏÇ¨Ïö©Îê©ÎãàÎã§.</span>
                </p>
                <!-- Í∏àÏï° Îπ†Î•∏ ÏûÖÎ†• Î≤ÑÌäº -->
                <div class="flex flex-wrap gap-2">
                    <template x-if="country === 'KR'">
                        <div class="flex flex-wrap gap-2">
                            <button type="button" @click="investmentAmount = 500000" 
                                    class="px-3 py-1 text-xs bg-slate-700 hover:bg-slate-600 rounded-lg">50Îßå</button>
                            <button type="button" @click="investmentAmount = 1000000" 
                                    class="px-3 py-1 text-xs bg-slate-700 hover:bg-slate-600 rounded-lg">100Îßå</button>
                            <button type="button" @click="investmentAmount = 2000000" 
                                    class="px-3 py-1 text-xs bg-slate-700 hover:bg-slate-600 rounded-lg">200Îßå</button>
                            <button type="button" @click="investmentAmount = 5000000" 
                                    class="px-3 py-1 text-xs bg-slate-700 hover:bg-slate-600 rounded-lg">500Îßå</button>
                        </div>
                    </template>
                    <template x-if="country === 'US'">
                        <div class="flex flex-wrap gap-2">
                            <button type="button" @click="investmentAmount = 500" 
                                    class="px-3 py-1 text-xs bg-slate-700 hover:bg-slate-600 rounded-lg">$500</button>
                            <button type="button" @click="investmentAmount = 1000" 
                                    class="px-3 py-1 text-xs bg-slate-700 hover:bg-slate-600 rounded-lg">$1,000</button>
                            <button type="button" @click="investmentAmount = 2000" 
                                    class="px-3 py-1 text-xs bg-slate-700 hover:bg-slate-600 rounded-lg">$2,000</button>
                            <button type="button" @click="investmentAmount = 5000" 
                                    class="px-3 py-1 text-xs bg-slate-700 hover:bg-slate-600 rounded-lg">$5,000</button>
                        </div>
                    </template>
                </div>
            </div>
            
            <div class="flex gap-3 pt-2">
                <a href="{{ url_for('stocks.list_stocks') }}"
                   class="flex-1 py-3 text-center bg-slate-700 hover:bg-slate-600 rounded-xl transition-colors">
                    Ï∑®ÏÜå
                </a>
                <button type="submit"
                        :disabled="!selectedStock && !manualTicker"
                        class="flex-1 py-3 bg-blue-600 hover:bg-blue-700 text-white rounded-xl transition-colors
                               disabled:bg-slate-600 disabled:cursor-not-allowed">
                    Ï∂îÍ∞ÄÌïòÍ∏∞
                </button>
            </div>
        </form>
    </div>
</div>

<script>
function stockSearch() {
    return {
        country: 'US',
        query: '',
        results: [],
        selectedStock: null,
        showDropdown: false,
        loading: false,
        manualMode: false,
        manualTicker: '',
        verifying: false,
        verifiedStock: null,
        verifyError: '',
        investmentAmount: null,
        
        async search() {
            if (this.query.length < 1) {
                this.results = [];
                return;
            }
            
            this.loading = true;
            
            try {
                const response = await fetch(`/api/search/stocks?q=${encodeURIComponent(this.query)}&country=${this.country}&limit=15`);
                const data = await response.json();
                
                if (data.success) {
                    this.results = data.data;
                    this.showDropdown = true;
                }
            } catch (error) {
                console.error('Í≤ÄÏÉâ Ïò§Î•ò:', error);
            } finally {
                this.loading = false;
            }
        },
        
        async verifyTicker() {
            if (this.manualTicker.length < 1) {
                this.verifiedStock = null;
                this.verifyError = '';
                return;
            }
            
            this.verifying = true;
            this.verifiedStock = null;
            this.verifyError = '';
            
            try {
                const response = await fetch(`/api/verify/ticker?ticker=${encodeURIComponent(this.manualTicker)}&country=${this.country}`);
                const data = await response.json();
                
                if (data.valid) {
                    this.verifiedStock = data.data;
                    this.verifyError = '';
                } else {
                    this.verifiedStock = null;
                    this.verifyError = data.error || 'Ï¢ÖÎ™©ÏùÑ Ï∞æÏùÑ Ïàò ÏóÜÏäµÎãàÎã§.';
                }
            } catch (error) {
                console.error('Í≤ÄÏ¶ù Ïò§Î•ò:', error);
                this.verifyError = 'Í≤ÄÏ¶ù Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.';
            } finally {
                this.verifying = false;
            }
        },
        
        selectStock(stock) {
            this.selectedStock = stock;
            this.query = stock.name;
            this.showDropdown = false;
            this.manualMode = false;
            this.manualTicker = '';
            this.verifiedStock = null;
            this.verifyError = '';
        },
        
        clearSelection() {
            this.selectedStock = null;
            this.query = '';
            this.investmentAmount = null;
        },
        
        submitForm(e) {
            // ÏßÅÏ†ë ÏûÖÎ†• Î™®ÎìúÏóêÏÑú Í≤ÄÏ¶ùÎêú Ï¢ÖÎ™©Îßå ÌóàÏö©
            if (this.manualMode) {
                if (this.verifiedStock) {
                    return true;
                } else {
                    e.preventDefault();
                    if (!this.manualTicker) {
                        alert('Ìã∞Ïª§Î•º ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî.');
                    } else {
                        alert('Ïú†Ìö®Ìïú Ï¢ÖÎ™©Ïù∏ÏßÄ ÌôïÏù∏Ìï¥Ï£ºÏÑ∏Ïöî.');
                    }
                    return false;
                }
            }
            
            // Í≤ÄÏÉâ Î™®ÎìúÏóêÏÑú ÏÑ†ÌÉùÎêú Ï¢ÖÎ™© ÏóÜÏúºÎ©¥ ÎßâÍ∏∞
            if (!this.selectedStock) {
                e.preventDefault();
                alert('Ï¢ÖÎ™©ÏùÑ ÏÑ†ÌÉùÌï¥Ï£ºÏÑ∏Ïöî.');
                return false;
            }
            return true;
        }
    }
}
</script>
{% endblock %}
