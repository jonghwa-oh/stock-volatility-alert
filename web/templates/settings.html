{% extends "base.html" %}

{% block title %}설정 - 주식 알림{% endblock %}

{% block content %}
<div class="max-w-2xl mx-auto space-y-6">
    <h1 class="text-2xl font-bold">⚙️ 설정</h1>
    
    <!-- 프로필 -->
    <div class="bg-slate-800 rounded-2xl p-6 border border-slate-700">
        <h2 class="text-lg font-bold mb-4">👤 프로필</h2>
        
        <div class="space-y-4">
            <div class="flex items-center justify-between">
                <span class="text-slate-400">사용자 이름</span>
                <span class="font-medium">{{ user.name }}</span>
            </div>
            <div class="flex items-center justify-between">
                <span class="text-slate-400">텔레그램 Chat ID</span>
                <span class="font-mono text-sm">{{ user.chat_id }}</span>
            </div>
            <div class="flex items-center justify-between">
                <span class="text-slate-400">투자 금액</span>
                <span class="font-medium">{{ "{:,.0f}".format(user.investment_amount) }}원</span>
            </div>
        </div>
    </div>
    
    <!-- 알림 설정 -->
    <div class="bg-slate-800 rounded-2xl p-6 border border-slate-700" 
         x-data="{ 
             enabled: {{ 'true' if user.notification_enabled else 'false' }},
             method: '{{ notification_method or 'telegram' }}',
             ntfyTopic: '{{ ntfy_topic or '' }}',
             saving: false,
             testSending: false,
             message: ''
         }">
        <h2 class="text-lg font-bold mb-4">🔔 알림 설정</h2>
        
        <div class="space-y-6">
            <!-- 알림 활성화 -->
            <div class="flex items-center justify-between">
                <div>
                    <p class="font-medium">실시간 알림</p>
                    <p class="text-sm text-slate-400">매수 타이밍 도달 시 알림 수신</p>
                </div>
                
                <button @click="
                    enabled = !enabled;
                    fetch('/api/user/notification', {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({enabled: enabled})
                    })
                " class="relative inline-flex h-6 w-11 items-center rounded-full transition-colors"
                   :class="enabled ? 'bg-blue-600' : 'bg-slate-600'">
                    <span class="inline-block h-4 w-4 transform rounded-full bg-white transition-transform"
                          :class="enabled ? 'translate-x-6' : 'translate-x-1'"></span>
                </button>
            </div>
            
            <!-- 알림 방식 선택 -->
            <div class="border-t border-slate-700 pt-4">
                <p class="font-medium mb-3">알림 방식</p>
                <div class="flex gap-4">
                    <label class="flex items-center gap-2 cursor-pointer">
                        <input type="radio" name="method" value="telegram" x-model="method"
                               class="w-4 h-4 text-blue-600 bg-slate-700 border-slate-600">
                        <span>텔레그램</span>
                    </label>
                    <label class="flex items-center gap-2 cursor-pointer">
                        <input type="radio" name="method" value="ntfy" x-model="method"
                               class="w-4 h-4 text-blue-600 bg-slate-700 border-slate-600">
                        <span>ntfy</span>
                    </label>
                </div>
            </div>
            
            <!-- ntfy 설정 (ntfy 선택 시) -->
            <div x-show="method === 'ntfy'" x-cloak class="border-t border-slate-700 pt-4 space-y-4">
                <div>
                    <label class="block text-sm text-slate-400 mb-2">ntfy 토픽</label>
                    <input type="text" x-model="ntfyTopic" 
                           placeholder="예: stock-alert-myname"
                           class="w-full px-4 py-3 bg-slate-700 border border-slate-600 rounded-xl focus:outline-none focus:border-blue-500">
                    <p class="text-xs text-slate-500 mt-1">ntfy 앱에서 구독한 토픽 이름을 입력하세요</p>
                </div>
                
                <div class="flex gap-2">
                    <button @click="
                        saving = true;
                        fetch('/api/settings/ntfy', {
                            method: 'POST',
                            headers: {'Content-Type': 'application/json'},
                            body: JSON.stringify({topic: ntfyTopic, method: method})
                        }).then(r => r.json()).then(d => {
                            message = d.success ? '✅ 저장되었습니다' : '❌ 저장 실패';
                            saving = false;
                            setTimeout(() => message = '', 3000);
                        })
                    " :disabled="saving || !ntfyTopic"
                       class="flex-1 py-3 bg-blue-600 hover:bg-blue-700 disabled:bg-slate-600 rounded-xl transition-colors">
                        <span x-text="saving ? '저장 중...' : '💾 저장'"></span>
                    </button>
                    
                    <button @click="
                        testSending = true;
                        fetch('/api/settings/ntfy/test', {
                            method: 'POST',
                            headers: {'Content-Type': 'application/json'},
                            body: JSON.stringify({topic: ntfyTopic})
                        }).then(r => r.json()).then(d => {
                            message = d.success ? '✅ 테스트 알림 전송!' : '❌ 전송 실패: ' + d.error;
                            testSending = false;
                            setTimeout(() => message = '', 5000);
                        })
                    " :disabled="testSending || !ntfyTopic"
                       class="px-6 py-3 bg-slate-700 hover:bg-slate-600 disabled:bg-slate-800 rounded-xl transition-colors">
                        <span x-text="testSending ? '전송 중...' : '🔔 테스트'"></span>
                    </button>
                </div>
                
                <p x-show="message" x-text="message" class="text-center py-2"></p>
            </div>
            
            <!-- 텔레그램 선택 시 -->
            <div x-show="method === 'telegram'" x-cloak class="border-t border-slate-700 pt-4">
                <p class="text-sm text-slate-400">기존 텔레그램 봇으로 알림을 받습니다.</p>
                <button @click="
                    saving = true;
                    fetch('/api/settings/ntfy', {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({method: 'telegram'})
                    }).then(r => r.json()).then(d => {
                        message = d.success ? '✅ 저장되었습니다' : '❌ 저장 실패';
                        saving = false;
                        setTimeout(() => message = '', 3000);
                    })
                " :disabled="saving"
                   class="mt-3 px-6 py-2 bg-blue-600 hover:bg-blue-700 disabled:bg-slate-600 rounded-xl transition-colors text-sm">
                    <span x-text="saving ? '저장 중...' : '💾 저장'"></span>
                </button>
                <p x-show="message" x-text="message" class="text-center py-2 mt-2"></p>
            </div>
        </div>
    </div>
    
    <!-- 보안 -->
    <div class="bg-slate-800 rounded-2xl p-6 border border-slate-700">
        <h2 class="text-lg font-bold mb-4">🔐 보안</h2>
        
        <a href="{{ url_for('auth.change_password') }}"
           class="flex items-center justify-between p-4 bg-slate-700/50 rounded-xl hover:bg-slate-700 transition-colors">
            <div>
                <p class="font-medium">비밀번호 변경</p>
                <p class="text-sm text-slate-400">웹 로그인 비밀번호를 변경합니다</p>
            </div>
            <span class="text-slate-400">→</span>
        </a>
    </div>
    
    <!-- 로그아웃 -->
    <a href="{{ url_for('auth.logout') }}"
       class="block w-full py-4 text-center bg-red-500/20 hover:bg-red-500/30 text-red-400 rounded-2xl transition-colors border border-red-500/30">
        🚪 로그아웃
    </a>
</div>
{% endblock %}





