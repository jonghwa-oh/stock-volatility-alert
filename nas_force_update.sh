#!/bin/bash
# NAS 강제 업데이트 스크립트
# 로컬 변경사항을 모두 버리고 원격 저장소의 최신 코드로 강제 덮어쓰기

# 로그 함수 (타임스탬프 포함)
log() {
    echo "[$(date '+%Y-%m-%d %H:%M:%S')] $1"
}

log "======================================================================="
log "⚠️  Stock Monitor 강제 업데이트"
log "======================================================================="
log "❗ 경고: 로컬의 모든 변경사항이 삭제됩니다!"
log "======================================================================="

# 프로젝트 디렉토리로 이동
cd /volume1/docker/stock-volatility-alert || {
    log "❌ 디렉토리를 찾을 수 없습니다: /volume1/docker/stock-volatility-alert"
    exit 1
}

log "✅ 현재 디렉토리: $(pwd)"
log ""

# 1. 현재 상태 확인
log "======================================================================="
log "📊 현재 상태"
log "======================================================================="
log "현재 브랜치:"
git branch --show-current
log ""
log "최근 커밋:"
git log --oneline -1
log ""
log "변경된 파일:"
git status --short
log ""

# 2. 원격 저장소 정보 가져오기
log "======================================================================="
log "📥 원격 저장소 정보 가져오기 (git fetch)"
log "======================================================================="
git fetch origin || {
    log "❌ git fetch 실패!"
    exit 1
}
log "✅ fetch 완료!"
log ""

# 3. 로컬 변경사항 모두 버리기
log "======================================================================="
log "🗑️  로컬 변경사항 삭제"
log "======================================================================="
log "⚠️  추적된 파일의 변경사항 삭제 중..."
git reset --hard HEAD || {
    log "❌ git reset 실패!"
    exit 1
}
log "✅ 추적된 파일 초기화 완료!"
log ""

log "⚠️  추적되지 않은 파일 삭제 중..."
git clean -fd || {
    log "❌ git clean 실패!"
    exit 1
}
log "✅ 추적되지 않은 파일 삭제 완료!"
log ""

# 4. 원격 저장소로 강제 동기화
log "======================================================================="
log "🔄 원격 저장소로 강제 동기화 (git reset --hard origin/main)"
log "======================================================================="
git reset --hard origin/main || {
    log "❌ git reset --hard origin/main 실패!"
    exit 1
}
log "✅ 강제 동기화 완료!"
log ""

# 5. 최종 상태 확인
log "======================================================================="
log "📊 업데이트 후 상태"
log "======================================================================="
log "현재 커밋:"
git log --oneline -1
log ""
log "상태:"
git status --short
if [ -z "$(git status --short)" ]; then
    log "✅ 변경사항 없음 (깨끗한 상태)"
else
    log "⚠️  아직 변경사항이 남아있음"
fi
log ""

# 6. 컨테이너 재시작
log "======================================================================="
log "🔄 컨테이너 재시작"
log "======================================================================="

log "🛑 컨테이너 중지..."
sudo docker-compose down || {
    log "❌ 컨테이너 중지 실패!"
    exit 1
}
log "✅ 컨테이너 중지 완료!"
log ""

log "🔨 이미지 재빌드 (캐시 사용 안함)..."
log "⚠️  5-10분 소요될 수 있습니다..."
sudo docker-compose build --no-cache || {
    log "❌ 이미지 빌드 실패!"
    exit 1
}
log "✅ 이미지 빌드 완료!"
log ""

log "🚀 컨테이너 시작..."
sudo docker-compose up -d || {
    log "❌ 컨테이너 시작 실패!"
    exit 1
}
log "✅ 컨테이너 시작 완료!"
log ""

# 7. 컨테이너 상태 확인
log "⏳ 5초 대기 중... (컨테이너 초기화)"
sleep 5
log ""

log "======================================================================="
log "📊 컨테이너 상태"
log "======================================================================="
sudo docker-compose ps
log ""

# 8. 최근 로그 확인
log "======================================================================="
log "📋 최근 로그 (최근 30줄)"
log "======================================================================="
sudo docker-compose logs --tail=30 stock-monitor
log ""

# 9. 완료
log "======================================================================="
log "✅ 강제 업데이트 완료!"
log "======================================================================="
log ""
log "📌 추가 명령어:"
log "   실시간 로그: sudo docker-compose logs -f stock-monitor"
log "   봇 로그: sudo docker exec stock_monitor cat /tmp/telegram_bot.log"
log "   스케줄러 로그: sudo docker exec stock_monitor cat /tmp/daily_updater.log"
log ""

