# WebSocket 실시간 매수 알림 가이드

## 📋 목차

1. [개요](#개요)
2. [기존 방식 vs WebSocket](#기존-방식-vs-websocket)
3. [설치 및 설정](#설치-및-설정)
4. [사용 방법](#사용-방법)
5. [작동 원리](#작동-원리)
6. [문제 해결](#문제-해결)

---

## 개요

### 🎯 목적

**진짜 실시간 매수 알림!**

WebSocket을 사용하여 주가 변동을 즉시 감지하고, 1-sigma/2-sigma 매수 타이밍에 도달하는 순간 텔레그램으로 알림을 보냅니다.

### ⚡ 핵심 특징

- **즉시 알림**: 가격 변동 즉시 감지 (5분 지연 X)
- **API 효율**: 한 번 연결로 계속 수신
- **정확성**: 목표가 도달 순간 알림
- **경량**: 서버/클라이언트 부하 최소화

---

## 기존 방식 vs WebSocket

### ❌ 기존 방식 (5분 폴링)

```
🕐 9:00 → API 호출 → 가격 확인
🕐 9:05 → API 호출 → 가격 확인
🕐 9:10 → API 호출 → 가격 확인
...
```

**문제점:**
- ⏰ 5분 지연 발생
- 💸 API 호출 과다 (하루 288회)
- 🎯 목표가 도달해도 최대 5분 후 알림
- 🔋 지속적인 서버 부하

### ✅ WebSocket 방식

```
🔌 연결 → 실시간 시세 수신
📊 71,000원 → 확인
📊 70,800원 → 확인
📊 70,600원 → 🚨 2차 매수 알림! (즉시)
```

**장점:**
- ⚡ 즉시 알림 (지연 0초)
- 💰 API 호출 1회 (연결만)
- 🎯 목표가 도달 즉시 알림
- 🔋 효율적인 자원 사용

---

## 설치 및 설정

### 1. 패키지 설치

```bash
pip install -r requirements.txt
```

**새로 추가된 패키지:**
- `websockets>=12.0`
- `pycryptodome>=3.19.0` (AES256 암호화)

### 2. 한국투자증권 API 설정

```bash
python init_kis_settings.py
```

WebSocket은 한국투자증권 API가 **필수**입니다!

### 3. WebSocket 승인키 발급 테스트

```bash
python kis_auth.py
```

**예상 출력:**
```
🔑 WebSocket approval key 발급 중...
✅ Approval key 발급 성공!
```

### 4. WebSocket 연결 테스트

```bash
python kis_websocket.py
```

**예상 출력:**
```
🔌 WebSocket 연결 중... ws://ops.koreainvestment.com:21000
✅ WebSocket 연결 성공!
📊 005930 실시간 시세 구독 시작
👂 10초간 실시간 데이터 수신 중...

📊 005930
   현재가: 71,000원
   전일대비: +1,000원 (+1.43%)
   체결시간: 09:15:32
```

---

## 사용 방법

### 실시간 모니터링 시작

```bash
python realtime_monitor_ws.py
```

### 실행 흐름

```
1. 초기화
━━━━━━━━━━━━━━━━━━━━━━━━━━━━
🚀 실시간 매수 알림 시스템 초기화 (WebSocket)

📊 모니터링 종목: 4개
🇰🇷 한국 주식: 2개 (WebSocket 모니터링)

📊 KODEX 레버리지 (122630) 분석 중...
  ✅ 1차 매수: 71,635원 (1.42% 하락)
  ✅ 2차 매수: 70,606원 (2.83% 하락)

📊 KODEX 200타겟위클리커버드콜 (498400) 분석 중...
  ✅ 1차 매수: 10,096원 (1.79% 하락)
  ✅ 2차 매수: 9,912원 (3.59% 하락)

✅ 초기화 완료: 2개 종목 모니터링 준비

2. 실시간 모니터링
━━━━━━━━━━━━━━━━━━━━━━━━━━━━
🔌 WebSocket 연결 중...
✅ WebSocket 연결 성공!
📊 122630 실시간 시세 구독 시작
📊 498400 실시간 시세 구독 시작

👂 실시간 모니터링 시작!
━━━━━━━━━━━━━━━━━━━━━━━━━━━━
📊 모니터링 종목: 2개
⏰ 시작 시간: 2025-11-30 09:00:00

💡 Ctrl+C로 종료
━━━━━━━━━━━━━━━━━━━━━━━━━━━━

3. 매수 알림 (목표가 도달 시)
━━━━━━━━━━━━━━━━━━━━━━━━━━━━
🚨 KODEX 레버리지 (122630) 2차 매수 알림 전송: 70,600원
  ✅ jjongz님에게 2차 매수 알림 전송
  ✅ bluejm님에게 2차 매수 알림 전송
```

### 텔레그램 알림 예시

```
🚨 매수 알림! 2차 매수 시점 도달

📊 KODEX 레버리지 (122630)
💰 현재가: 70,600원
🎯 목표가: 70,606원
📉 하락률: 2.83%

⏰ 2025-11-30 14:32:15

💡 2차 매수 타이밍입니다! (2배 투자)

[차트 이미지]
```

---

## 작동 원리

### 1. 초기화

```python
1. DB에서 활성 사용자 조회
2. 각 사용자의 관심 종목 수집
3. 한국 주식만 필터링
4. 종목별 1-sigma/2-sigma 매수 목표가 계산
5. 메모리에 캐시
```

### 2. WebSocket 연결

```python
1. approval key 발급
2. WebSocket 연결 (ws://ops.koreainvestment.com:21000)
3. 종목별 실시간 시세 구독 (H0STCNT0)
```

### 3. 실시간 모니터링

```python
while True:
    1. WebSocket에서 실시간 시세 수신
    2. 현재가와 목표가 비교
    3. 목표가 도달 시:
        a. 알림 메시지 생성
        b. 차트 이미지 첨부
        c. 해당 종목 관심 있는 사용자에게 텔레그램 전송
        d. 중복 알림 방지 (5분 내)
```

### 4. 중복 알림 방지

```python
alert_history = {
    '122630': {
        '1x': datetime(2025, 11, 30, 9, 15),
        '2x': datetime(2025, 11, 30, 14, 32)
    }
}

# 동일 레벨 알림은 5분 후에만 재전송
```

---

## 주요 파일

### kis_websocket.py

WebSocket 클라이언트 구현

**주요 기능:**
- WebSocket 연결 관리
- 실시간 시세 구독/해제
- 데이터 수신 및 파싱
- AES256 암호화/복호화

**주요 메서드:**
```python
await ws.connect()                        # 연결
await ws.subscribe_price(ticker, callback) # 구독
await ws.listen()                         # 수신
await ws.disconnect()                     # 종료
```

### realtime_monitor_ws.py

실시간 모니터링 및 알림

**주요 기능:**
- 매수 목표가 계산 및 캐시
- WebSocket 실시간 시세 수신
- 목표가 도달 감지
- 텔레그램 알림 전송
- 중복 알림 방지

**주요 메서드:**
```python
await monitor.initialize()        # 초기화
await monitor.start_monitoring()  # 모니터링 시작
await monitor.check_and_alert()   # 가격 확인 및 알림
```

### kis_auth.py

WebSocket 승인키 발급 추가

**추가된 메서드:**
```python
auth.get_websocket_approval_key()  # approval key 발급
```

---

## 비교표

| 기능 | 기존 (5분 폴링) | WebSocket |
|------|----------------|-----------|
| **알림 지연** | 최대 5분 | 즉시 (0초) |
| **API 호출** | 하루 288회 | 1회 (연결) |
| **정확성** | 5분 간격 | 실시간 |
| **서버 부하** | 높음 | 낮음 |
| **한국 주식** | FinanceDataReader | KIS API |
| **미국 주식** | FinanceDataReader | 지원 안 함* |
| **배터리** | 많이 소모 | 적게 소모 |

*미국 주식은 기존 5분 폴링 방식 유지

---

## 장단점

### ✅ 장점

1. **즉시 알림**
   - 매수 타이밍을 놓치지 않음
   - 가격 도달 즉시 텔레그램 수신

2. **효율성**
   - API 호출 1회로 계속 수신
   - 서버/클라이언트 자원 절약

3. **정확성**
   - 실시간 체결가 기준
   - 목표가 도달 순간 포착

4. **확장성**
   - 여러 종목 동시 모니터링
   - 멀티 유저 지원

### ⚠️ 단점

1. **한국 주식만 지원**
   - 미국 주식은 WebSocket 미지원
   - 기존 5분 폴링 병행 필요

2. **연결 안정성**
   - 네트워크 끊김 시 재연결 필요
   - 장시간 실행 시 관리 필요

3. **복잡성**
   - 기존 방식보다 구현 복잡
   - 비동기 프로그래밍 필요

---

## 문제 해결

### 1. WebSocket 연결 실패

**증상:**
```
❌ WebSocket 연결 실패: Connection refused
```

**해결:**
1. 한국투자증권 API 설정 확인
2. approval key 재발급:
```bash
python -c "from database import StockDatabase; db = StockDatabase(); db.delete_setting('kis_approval_key'); db.close()"
python kis_auth.py
```

### 2. 실시간 데이터 수신 안 됨

**증상:**
```
👂 실시간 데이터 수신 대기 중...
(아무 메시지 없음)
```

**해결:**
1. 장 시간인지 확인 (평일 09:00~15:30)
2. 종목코드 확인 (6자리 숫자)
3. 구독 확인:
```python
print(ws.subscriptions)  # 구독 목록 출력
```

### 3. 알림이 안 옴

**증상:**
```
실시간 데이터는 수신되는데 알림이 안 옴
```

**해결:**
1. 목표가 계산 확인:
```python
print(monitor.target_prices)
```

2. 현재가가 목표가보다 높은지 확인
3. 중복 알림 방지 확인 (5분 내 재알림 X)

### 4. 메모리 과다 사용

**증상:**
```
장시간 실행 후 메모리 증가
```

**해결:**
1. 주기적으로 재시작 (하루 1회 권장)
2. Cron으로 자동 재시작:
```bash
0 9 * * * cd /path/to/project && python realtime_monitor_ws.py
```

---

## 통합 실행 (추천)

### scheduler_main.py

**일일 분석 + WebSocket 모니터링**

```bash
python scheduler_main.py
```

**실행 흐름:**
```
1. 매일 08:50 (월~금)
   └── daily_analysis.py 실행
       • 1년치 데이터 분석
       • 매수 목표가 계산
       • 차트 생성
       • 텔레그램 전송

2. 장 시작 (09:00)
   └── realtime_monitor_ws.py 실행
       • WebSocket 연결
       • 실시간 모니터링
       • 매수 타이밍 알림

3. 장 마감 (15:30)
   └── WebSocket 종료
       • 연결 해제
       • 리소스 정리
```

---

## 다음 단계

### 🔜 향후 개선 사항

1. **재연결 로직**
   - WebSocket 끊김 시 자동 재연결
   - 네트워크 오류 복구

2. **미국 주식 지원**
   - 미국 주식도 WebSocket 모니터링
   - 다른 데이터 소스 통합

3. **알림 커스터마이징**
   - 사용자별 알림 설정
   - 알림 빈도 조절

4. **모니터링 대시보드**
   - 웹 대시보드 구축
   - 실시간 가격 차트

---

## 참고 문서

- [한국투자증권 WebSocket API](https://apiportal.koreainvestment.com)
- [KIS API 가이드](KIS_API_GUIDE.md)
- [프로젝트 README](../README.md)

---

**WebSocket으로 진짜 실시간 알림을 경험하세요!** 🚀📊

