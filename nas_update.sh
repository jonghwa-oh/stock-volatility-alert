#!/bin/bash
# NAS 업데이트 및 재시작 스크립트

# 로그 함수 (타임스탬프 포함)
log() {
    echo "[$(date '+%Y-%m-%d %H:%M:%S')] $1"
}

log "======================================================================="
log "🔄 Stock Monitor 업데이트 시작"
log "======================================================================="

log "✅ 현재 디렉토리: $(pwd)"
log ""

# 1. 현재 Git 상태 확인
log "======================================================================="
log "📊 현재 상태 확인"
log "======================================================================="
log "현재 브랜치:"
git branch --show-current
log ""
log "최근 커밋:"
git log --oneline -1
log ""

# 2. Git Pull
log "======================================================================="
log "📥 최신 코드 받기 (git pull)"
log "======================================================================="
git pull || {
    log "❌ git pull 실패!"
    exit 1
}
log "✅ git pull 완료!"
log ""
log "업데이트 후 커밋:"
git log --oneline -1
log ""

# 3. 컨테이너 중지
log "======================================================================="
log "🛑 컨테이너 중지 (docker-compose down)"
log "======================================================================="
sudo docker-compose down || {
    log "❌ 컨테이너 중지 실패!"
    exit 1
}
log "✅ 컨테이너 중지 완료!"
log ""

# 4. 이미지 재빌드 (캐시 무시)
log "======================================================================="
log "🔨 이미지 재빌드 (docker-compose build --no-cache)"
log "======================================================================="
log "⚠️  캐시를 사용하지 않으므로 5-10분 소요될 수 있습니다..."
log ""
sudo docker-compose build --no-cache || {
    log "❌ 이미지 빌드 실패!"
    exit 1
}
log "✅ 이미지 빌드 완료!"
log ""

# 5. 컨테이너 시작
log "======================================================================="
log "🚀 컨테이너 시작 (docker-compose up -d)"
log "======================================================================="
sudo docker-compose up -d || {
    log "❌ 컨테이너 시작 실패!"
    exit 1
}
log "✅ 컨테이너 시작 완료!"
log ""

# 6. 컨테이너 상태 확인
log "⏳ 5초 대기 중... (컨테이너 초기화)"
sleep 5
log ""

log "======================================================================="
log "📊 컨테이너 상태 확인"
log "======================================================================="
sudo docker-compose ps
log ""

# 7. 최근 로그 확인
log "======================================================================="
log "📋 최근 로그 (최근 30줄)"
log "======================================================================="
sudo docker-compose logs --tail=30 stock-monitor
log ""

# 8. 완료
log "======================================================================="
log "✅ 업데이트 완료!"
log "======================================================================="
log ""
log "📌 추가 명령어:"
log "   실시간 로그: sudo docker-compose logs -f stock-monitor"
log "   봇 로그: sudo docker exec stock_monitor cat /tmp/telegram_bot.log"
log "   스케줄러 로그: sudo docker exec stock_monitor cat /tmp/daily_updater.log"
log "   컨테이너 재시작: sudo docker-compose restart"
log ""

